<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Museo 3D - Organizado (con joysticks y luces)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <!-- look-at para que el texto del portal mire a la cámara si lo necesitas -->
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <!-- nipplejs para joysticks táctiles -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }

    /* Joysticks táctiles (solo en pantallas pequeñas) */
    #leftJoystick, #rightJoystick {
      position: absolute;
      bottom: 8vh;
      width: 30vw;
      height: 30vw;
      max-width: 220px;
      max-height: 220px;
      touch-action: none;
      z-index: 1000;
      pointer-events: auto;
    }
    #leftJoystick { left: 3vw; }
    #rightJoystick { right: 3vw; }

    @media (min-width: 900px) {
      #leftJoystick, #rightJoystick { display: none; }
    }

    /* Texto de bienvenida pequeño (si deseas estilo extra) */
    .welcome-text { color: #00ffff; text-shadow: 0 0 6px rgba(0,255,255,0.5); }

    /* (Opcional) evita selección accidental en móviles */
    * { -webkit-user-select: none; -ms-user-select: none; user-select: none; }
  </style>
</head>

<body>

  <!-- Contenedores para joysticks (si no existen, el script los creará) -->
  <div id="leftJoystick"></div>
  <div id="rightJoystick"></div>

  <a-scene>

    <a-assets>
      <img id="groundTexture" src="https://cdn.aframe.io/a-painter/images/floor.jpg" />
      <img id="skyTexture" src="https://cdn.aframe.io/a-painter/images/sky.jpg" />
      <a-asset-item id="museoModel" src="https://raw.githubusercontent.com/GabrielCaroG/modelo3d/main/MUSEO.glb"></a-asset-item>
    </a-assets>

    <!-- RIG + Cámara -->
    <a-entity id="rig" position="0 1.6 0" vr-controls>
      <a-entity camera look-controls wasd-controls position="0 0 0">
        <!-- Cursor que solo interactúa con objetos con la clase "interactivo" -->
        <a-cursor
          raycaster="objects: .interactivo"
          fuse="false"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: white; shader: flat">
        </a-cursor>

        <!-- Luz anclada a la cámara -->
        <a-entity light="type: point; color: #ffffff; intensity: 3; distance: 10"></a-entity>
      </a-entity>

      <!-- hand controllers (para detectar thumbstick en VR) -->
      <a-entity id="leftHand" meta-touch-controls="hand: left; model: true"></a-entity>
      <a-entity id="rightHand" meta-touch-controls="hand: right; model: true"></a-entity>
    </a-entity>

    <!-- Texto de controles anclado en 0 2 -1.7, un poco al frente -->
    <a-entity id="welcomeText"
              position="0 2 -1.7"
              text="value: Bienvenido — Muévete por el museo con WASD / flechas (PC) o con los joysticks (celular); align: center; wrapCount: 30; width: 2; color: #00ffff"
              class="welcome-text">
    </a-entity>

    <!-- Piso, cielo y luces globales (añadidas) -->
    <a-cylinder id="ground" src="#groundTexture" radius="175" height="0.1"></a-cylinder>
    <a-sky id="background" src="#skyTexture" theta-length="90" radius="175"></a-sky>

    <!-- Directional global (como en tu segundo fragmento) -->
    <a-entity light="type: directional; color: #ffffff; intensity: 0.8; castShadow: true"
              position="0 10 5" rotation="-45 0 0"></a-entity>

    <!-- Luz principal cerca del modelo principal (point) -->
    <a-light type="point" color="#ffffff" intensity="5" distance="15" position="0 5 -1"></a-light>

    <!-- Modelo principal -->
    <a-entity gltf-model="#museoModel" position="0 0 -3" scale="1 1 1" rotation="0 0 0"></a-entity>

    <!-- objetos-museo (completo) -->
    <a-entity id="objetos-museo" position="0 0 0">
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/1.glb)" scale="1 2 1" position="-10 1.7 -41.4"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/2.glb)" scale="1 2 1" position="-10 1.7 -37" rotation="20 290 -20"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/3.glb)" scale="1 2 1" position="-10 1.5 -32.7" rotation="275 0 50"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/4.glb)" scale="1 2 1" position="-15.2 1.5 -32.7" rotation="275 0 280"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/5.glb)" scale="1 2 1" position="-20.5 1.3 -32.7" rotation="275 0 280"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/6.glb)" scale="1 2 1" position="-26.5 1.5 -32.7" rotation="275 0 280"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/7.glb)" scale="1 2 1" position="-32.2 1.3 -32.7" rotation="275 0 280"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/8.glb)" scale="1 2 1" position="-37.9 1.5 -32.7" rotation="275 0 280"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/9.glb)" scale="1 2 1" position="-44 1.5 -32.7" rotation="0 0 -290"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/10.glb)" scale="1 2 1" position="-50 1.5 -32.7" rotation="275 0 100"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/11.glb)" scale="1 2 1" position="-55.6 1.5 -32.7" rotation="275 0 100"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/12.glb)" scale="1 2 1" position="-60.4 1.5 -32.7" rotation="275 0 100"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/13.glb)" scale="1 2 1" position="-65.6 1.5 -32.7" rotation="275 0 100"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/14.glb)" scale="1 2 1" position="-68.6 1.3 -36" rotation="275 0 270"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/15.glb)" scale="1 2 1" position="-68.6 1.5 -40.8" rotation="275 0 20"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/16.glb)" scale="1 2 1" position="-68.6 1.8 -45.6" rotation="180 -90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/17.glb)" scale="1 2 1" position="-68.6 1.3 -50" rotation="275 0 20"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/18.glb)" scale="1 2 1" position="-68.6 1.5 -55.2" rotation="275 0 100"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/19.glb)" scale="1 2 1" position="-68.6 1.5 -60" rotation="275 0 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/20.glb)" scale="1 2 1" position="-68.6 1.5 -65" rotation="0 0 100"></a-entity>

      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/21.glb)" scale="1 2 1" position="-65.6 1.5 -68.2" rotation="270 -90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/22.glb)" scale="1 2 1" position="-60.6 1.5 -68.2" rotation="270 -90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/23.glb)" scale="1 2 1" position="-55.6 1.5 -68.2" rotation="270 -90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/24.glb)" scale="1 2 1" position="-50.5 1.5 -68.2" rotation="190 180 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/25.glb)" scale="1 2 1" position="-45.5 1.5 -68.2" rotation="270 -90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/26.glb)" scale="1 2 1" position="-40.3 1.5 -68.2" rotation="270 90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/27.glb)" scale="1 2 1" position="-35 1.5 -68.2" rotation="270 90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/28.glb)" scale="1 2 1" position="-30 1.5 -68.2" rotation="0 180 50"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/29.glb)" scale="1 2 1" position="-25.3 1.5 -68.2" rotation="270 90 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/30.glb)" scale="1 2 1" position="-20.6 1.5 -68.2" rotation="0 180 90"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/31.glb)" scale="1 2 1" position="-16.5 1.5 -68.2" rotation="180 -180 90"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/32.glb)" scale="1 2 1" position="-11.8 1.5 -68.2" rotation="0 180 90"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/33.glb)" scale="1 2 1" position="-9.9 1.5 -64.8" rotation="-90 180 45"></a-entity>

      <!-- Nuevos objetos añadidos -->
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/34.glb)" scale="1 2 1" position="-9.9 1.5 -59.7" rotation="20 290 60"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/35.glb)" scale="1 2 1" position="-9.9 2.0 -55.2" rotation="20 290 180"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/36.glb)" scale="1 2 1" position="-9.9 2.0 -53.2" rotation="0 180 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/37.glb)" scale="1 2 1" position="-9.9 2.0 -52.2" rotation="0 180 0"></a-entity>
      <a-entity gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/38.glb)" scale="1 2 1" position="-9.9 2.0 -51.2" rotation="0 180 0"></a-entity>
    </a-entity>

    <!-- Portal: con rotación automática -->
    <a-box id="portal" class="interactivo" position="30 1.3 -48" depth="0.2" height="1.2" width="1.6" color="#FF6F61"
           animation="property: rotation; to: 0 360 0; loop: true; dur: 12000; easing: linear">
      <a-text value="ANIMACION" align="center" position="0 0 0.15" color="#050505"></a-text>
    </a-box>

    <!-- Texto encima del portal que indica el gaze de 5s -->
    <a-entity id="portalText"
              position="30 2.4 -48"
              look-at="#rig [camera]"
              text="value: Mira este cubo por 5 segundos para teletransportarte a la escena de Dilan Cruz; align: center; wrapCount: 30; width: 2; color: #ffffff">
    </a-entity>

  </a-scene>

  <!-- ----------------------------
       COMPONENTES / SCRIPTS
       ---------------------------- -->

  <!-- 1) gaze-redirect / gaze ring (usa 5000 ms para teletransportar) -->
  <script>
    (function (){
      const GAZE_MS = 5000;
      const UPDATE_MS = 60;

      function attachGazeRingToCamera() {
        const cam = document.querySelector('#rig [camera]');
        if (!cam) return null;
        const ring = document.createElement('a-entity');
        ring.setAttribute('id', 'gazeRing');
        ring.setAttribute('geometry', 'primitive: ring; radiusInner:0.02; radiusOuter:0.03');
        ring.setAttribute('material', 'shader: flat; opacity: 0.6; color: #00ffff');
        ring.setAttribute('position', '0 0 -0.45');
        ring.setAttribute('visible', 'false');
        cam.appendChild(ring);
        return ring;
      }

      function setupGazeRedirect(portalEl, targetUrl) {
        const gazeRing = attachGazeRingToCamera();
        let intervalId = null;
        let elapsed = 0;

        function start() {
          if (!gazeRing) return;
          clearInterval(intervalId);
          gazeRing.setAttribute('visible', 'true');
          elapsed = 0;
          intervalId = setInterval(() => {
            elapsed += UPDATE_MS;
            const frac = Math.min(elapsed / GAZE_MS, 1);
            const inner = 0.02 + 0.03 * frac;
            const outer = 0.03 + 0.04 * frac;
            gazeRing.setAttribute('geometry', `primitive: ring; radiusInner:${inner}; radiusOuter:${outer}`);
            if (elapsed >= GAZE_MS) {
              clearInterval(intervalId);
              window.location.href = targetUrl;
            }
          }, UPDATE_MS);
        }

        function clear() {
          if (intervalId) { clearInterval(intervalId); intervalId = null; }
          if (gazeRing) { gazeRing.setAttribute('visible', 'false'); }
          elapsed = 0;
          gazeRing && gazeRing.setAttribute('geometry', 'primitive: ring; radiusInner:0.02; radiusOuter:0.03');
        }

        portalEl.addEventListener('mouseenter', start);
        portalEl.addEventListener('mouseleave', clear);
        portalEl.addEventListener('click', () => { window.location.href = targetUrl; });
      }

      window.addEventListener('load', () => {
        const portal = document.getElementById('portal');
        if (!portal) return;
        portal.classList.add('interactivo');
        setupGazeRedirect(portal, 'https://dylanpinilla.github.io/Animaciondil/');
      });
    })();
  </script>

  <!-- 2) gaze-animate componente (de tu código original) -->
  <script>
    AFRAME.registerComponent('gaze-animate', {
      schema: {
        scaleFactor: { type: 'number', default: 1.5 },
        rotDegPerSec: { type: 'number', default: 80 },
        lift: { type: 'number', default: 0.5 },
        delay: { type: 'number', default: 2000 }
      },
      init: function () {
        const s = this.el.getAttribute('scale') || { x:1, y:1, z:1 };
        const p = this.el.getAttribute('position') || { x:0, y:0, z:0 };
        const r = this.el.getAttribute('rotation') || { x:0, y:0, z:0 };
        this.originalScale = { x: s.x, y: s.y, z: s.z };
        this.originalPos = { x: p.x, y: p.y, z: p.z };
        this.originalRot = { x: r.x, y: r.y, z: r.z };
        this.isActive = false;
        this.rotSpeed = (this.data.rotDegPerSec * Math.PI) / 180;
        this._onEnter = this.onEnter.bind(this);
        this._onLeave = this.onLeave.bind(this);
        this.leaveTimeout = null;
        this.el.addEventListener('mouseenter', this._onEnter);
        this.el.addEventListener('mouseleave', this._onLeave);
      },
      onEnter: function () {
        if (this.leaveTimeout) { clearTimeout(this.leaveTimeout); this.leaveTimeout = null; }
        if (this.isActive) return;
        this.isActive = true;
        const nx = this.originalScale.x * this.data.scaleFactor;
        const ny = this.originalScale.y * this.data.scaleFactor;
        const nz = this.originalScale.z * this.data.scaleFactor;
        const px = this.originalPos.x;
        const py = this.originalPos.y + this.data.lift;
        const pz = this.originalPos.z;
        this.el.removeAttribute('animation__scale_down');
        this.el.removeAttribute('animation__scale_up');
        this.el.removeAttribute('animation__pos_down');
        this.el.removeAttribute('animation__pos_up');
        this.el.removeAttribute('animation__rot_down');
        this.el.setAttribute('animation__scale_up', {
          property: 'scale', to: `${nx} ${ny} ${nz}`, dur: 300, easing: 'easeOutQuad'
        });
        this.el.setAttribute('animation__pos_up', {
          property: 'position', to: `${px} ${py} ${pz}`, dur: 300, easing: 'easeOutQuad'
        });
      },
      onLeave: function () {
        if (!this.isActive) return;
        this.leaveTimeout = setTimeout(() => {
          this.isActive = false;
          const ox = this.originalScale.x;
          const oy = this.originalScale.y;
          const oz = this.originalScale.z;
          const px = this.originalPos.x;
          const py = this.originalPos.y;
          const pz = this.originalPos.z;
          const rx = this.originalRot.x;
          const ry = this.originalRot.y;
          const rz = this.originalRot.z;
          this.el.removeAttribute('animation__scale_up');
          this.el.removeAttribute('animation__scale_down');
          this.el.removeAttribute('animation__pos_up');
          this.el.removeAttribute('animation__pos_down');
          this.el.removeAttribute('animation__rot_down');
          this.el.setAttribute('animation__scale_down', { property: 'scale', to: `${ox} ${oy} ${oz}`, dur: 300, easing: 'easeOutQuad' });
          this.el.setAttribute('animation__pos_down', { property: 'position', to: `${px} ${py} ${pz}`, dur: 300, easing: 'easeOutQuad' });
          this.el.setAttribute('animation__rot_down', { property: 'rotation', to: `${rx} ${ry} ${rz}`, dur: 300, easing: 'easeOutQuad' });
        }, this.data.delay);
      },
      tick: function (time, timeDelta) {
        if (!this.isActive) return;
        const rot = this.el.object3D.rotation;
        const step = this.rotSpeed * (timeDelta / 1000);
        rot.y += step;
        rot.x += step * 0.5;
      },
      remove: function () {
        this.el.removeEventListener('mouseenter', this._onEnter);
        this.el.removeEventListener('mouseleave', this._onLeave);
        if (this.leaveTimeout) clearTimeout(this.leaveTimeout);
      }
    });

    // Marcar los modelos dentro de #objetos-museo como interactivos
    document.addEventListener('DOMContentLoaded', function () {
      const list = document.querySelectorAll('#objetos-museo [gltf-model], #objetos-museo a-entity[gltf-model]');
      list.forEach(el => {
        el.classList.add('interactivo');
        el.setAttribute('gaze-animate', '');
      });
    });
  </script>

  <!-- 3) Función crearLuzT y añadida de luces en posiciones predefinidas -->
  <script>
    function crearLuzT(pos, rot) {
      const wrapper = document.createElement('a-entity');
      wrapper.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
      wrapper.setAttribute('rotation', `${rot.x} ${rot.y} ${rot.z}`);

      const modelo = document.createElement('a-entity');
      modelo.setAttribute('gltf-model', 'https://raw.githubusercontent.com/GabrielCaroG/modelo3d/main/LuzT.glb');
      modelo.setAttribute('scale', '1 1 1');
      modelo.setAttribute('rotation', '0 0 0');

      const luz = document.createElement('a-entity');
      luz.setAttribute('light', 'type: point; color: #ffffff; intensity: 5; distance: 10');
      luz.setAttribute('position', '0 2.5 -11');

      wrapper.appendChild(modelo);
      wrapper.appendChild(luz);

      return wrapper;
    }

    // Añadir las luces en posiciones predefinidas cuando la escena esté lista
    window.addEventListener('load', () => {
      const scene = document.querySelector('a-scene');
      if (!scene) return;

      const posiciones = [
        { x: 0, y: 0, z: 0 },
        { x: 0, y: 0, z: -19 },
        { x: 0, y: 0, z: -38 },
        { x: 0, y: 0, z: -60 },
        { x: -19, y: 0, z: -46.85 },
        { x: -38, y: 0, z: -46.85 },
        { x: -57, y: 0, z: -46.85 },
        { x: -38, y: 0, z: -28 },
        { x: -19, y: 0, z: -28 },
        { x: -57, y: 0, z: -28 },
        { x: -15, y: 0, z: -69 },
        { x: 15, y: 0, z: -69 },
        { x: 0, y: 0, z: -69 },
        { x: 10, y: 0, z: -36 },
        { x: 20, y: 0, z: -36 },
        { x: 30, y: 0, z: -36 }
      ];

      posiciones.forEach(pos => {
        scene.appendChild(crearLuzT(pos, { x: 0, y: 0, z: 0 }));
      });
    });
  </script>

  <!-- 4) vr-controls actualizado + integración con nipplejs (joysticks táctiles) -->
  <script>
    AFRAME.registerComponent("vr-controls", {
      schema: {
        moveSpeed: { type: "number", default: 0.12 },
        rotateSpeed: { type: "number", default: 2.0 },
        deadzone: { type: "number", default: 0.15 },
      },
      init: function () {
        this.rig = document.querySelector("#rig");
        this.cam = this.rig.querySelector("[camera]");
        this.leftX = 0;
        this.leftY = 0;
        this.rightX = 0;

        // VR thumbsticks (si están disponibles)
        const leftHand = document.querySelector("#leftHand");
        const rightHand = document.querySelector("#rightHand");

        if (leftHand) {
          leftHand.addEventListener("thumbstickmoved", (evt) => {
            this.leftX = evt.detail.x;
            this.leftY = evt.detail.y;
            document.dispatchEvent(new CustomEvent('joystickMove')); // para ocultar loading si se usara
          });
          leftHand.addEventListener("thumbstickreleased", () => {
            this.leftX = 0; this.leftY = 0;
          });
        }

        if (rightHand) {
          rightHand.addEventListener("thumbstickmoved", (evt) => {
            this.rightX = evt.detail.x;
            document.dispatchEvent(new CustomEvent('joystickMove'));
          });
          rightHand.addEventListener("thumbstickreleased", () => {
            this.rightX = 0;
          });
        }

        // Setup joysticks táctiles (nipplejs)
        this.setupTouchJoysticks();
      },

      setupTouchJoysticks: function () {
        if (this.joysticksSetup) return;
        this.joysticksSetup = true;

        // referencias a contenedores (creados en el body)
        let leftDiv = document.getElementById("leftJoystick");
        let rightDiv = document.getElementById("rightJoystick");

        if (!leftDiv) {
          leftDiv = document.createElement("div");
          leftDiv.id = "leftJoystick";
          document.body.appendChild(leftDiv);
        }
        if (!rightDiv) {
          rightDiv = document.createElement("div");
          rightDiv.id = "rightJoystick";
          document.body.appendChild(rightDiv);
        }

        // opciones
        const optionsLeft = {
          zone: leftDiv,
          mode: "static",
          position: { left: "50%", top: "50%" },
          color: "#00ffff",
          size: 120,
          restOpacity: 0.6,
        };
        const optionsRight = {
          zone: rightDiv,
          mode: "static",
          position: { left: "50%", top: "50%" },
          color: "#ff9900",
          size: 100,
          restOpacity: 0.6,
        };

        this.leftManager = nipplejs.create(optionsLeft);
        this.rightManager = nipplejs.create(optionsRight);

        // left joystick: movimiento (x lateral, y adelante/atrás)
        this.leftManager.on("move", (evt, data) => {
          if (!data || !data.vector) return;
          this.leftX = data.vector.x;
          this.leftY = -data.vector.y; // invertimos para que empujar arriba vaya hacia adelante
          document.dispatchEvent(new CustomEvent('joystickMove'));
        });
        this.leftManager.on("end", () => { this.leftX = 0; this.leftY = 0; });

        // right joystick: rotación horizontal
        this.rightManager.on("move", (evt, data) => {
          if (!data || !data.vector) return;
          this.rightX = data.vector.x;
          document.dispatchEvent(new CustomEvent('joystickMove'));
        });
        this.rightManager.on("end", () => { this.rightX = 0; });
      },

      tick: function (time, timeDelta) {
        if (!this.rig || !this.cam) return;
        const data = this.data;
        const rigObj = this.rig.object3D;
        const camObj = this.cam.object3D;

        // Movimiento en dirección de la cámara
        if (Math.abs(this.leftX) > data.deadzone || Math.abs(this.leftY) > data.deadzone) {
          const forward = new THREE.Vector3();
          camObj.getWorldDirection(forward);
          forward.y = 0; forward.normalize();

          const right = new THREE.Vector3();
          right.crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

          // usar clones para no alterar forward/right originales
          const moveForward = forward.clone().multiplyScalar(this.leftY * data.moveSpeed);
          const moveRight = right.clone().multiplyScalar(this.leftX * data.moveSpeed);
          rigObj.position.add(moveForward);
          rigObj.position.add(moveRight);
        }

        // Rotación del rig
        if (Math.abs(this.rightX) > data.deadzone) {
          rigObj.rotation.y -= this.rightX * this.data.rotateSpeed * 0.05;
        }
      }
    });
  </script>

</body>
</html>
